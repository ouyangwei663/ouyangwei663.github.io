<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>微前端小试 | 博客</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="Hi">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.75e7fe11.css" as="style"><link rel="preload" href="/assets/js/app.053dbcbc.js" as="script"><link rel="preload" href="/assets/js/2.7f8ecedc.js" as="script"><link rel="preload" href="/assets/js/11.aebc598d.js" as="script"><link rel="prefetch" href="/assets/js/10.4b10b7ab.js"><link rel="prefetch" href="/assets/js/12.27ab6a74.js"><link rel="prefetch" href="/assets/js/13.09d6c27f.js"><link rel="prefetch" href="/assets/js/14.e4a3d6cc.js"><link rel="prefetch" href="/assets/js/15.13db9c56.js"><link rel="prefetch" href="/assets/js/16.e210dca5.js"><link rel="prefetch" href="/assets/js/17.05f5e78e.js"><link rel="prefetch" href="/assets/js/18.6e75a0a6.js"><link rel="prefetch" href="/assets/js/19.e45d34bd.js"><link rel="prefetch" href="/assets/js/20.f6497181.js"><link rel="prefetch" href="/assets/js/3.17b2d5e4.js"><link rel="prefetch" href="/assets/js/4.00d5efe8.js"><link rel="prefetch" href="/assets/js/5.f71f9b07.js"><link rel="prefetch" href="/assets/js/6.a16f5917.js"><link rel="prefetch" href="/assets/js/7.dba0ee9b.js"><link rel="prefetch" href="/assets/js/8.198b1090.js"><link rel="prefetch" href="/assets/js/9.9c23ba08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.75e7fe11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="/logo.jpg" alt="博客" class="logo"> <span class="site-name">博客</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item ant-menu-item-selected"><a href="/front-end/" class="router-link-active">
          🍃前端
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/notes/">
          📒笔记
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          🌱其他
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          🌈联系
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><a href="/front-end/" aria-current="page" title="前端" class="sidebar-link">前端</a></li><li><a href="/front-end/在VScode中进行调试.html" title="在VScode中进行调试" class="sidebar-link">在VScode中进行调试</a></li><li><a href="/front-end/元素视口交叉.html" title="元素视口交叉" class="sidebar-link">元素视口交叉</a></li><li><a href="/front-end/Flex布局.html" title="Flex布局" class="sidebar-link">Flex布局</a></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="微前端小试"><a href="#微前端小试" class="header-anchor">#</a> 微前端小试</h1> <h2 id="微前端"><a href="#微前端" class="header-anchor">#</a> 微前端</h2> <p>下文旨在浅略尝试微前端搭建。</p> <p>微前端先从微服务说起，微服务是一种软件架构风格，以专注于单一责任与功能的小型功能区块为基础，利用模块化的方式组合出复杂的大型应用程序，各功能块与语言无关。</p> <p>在微前端这边，随着工程化、组件化的兴起，前端大部分代码都可以实现抽离，各自维护管理，但当项目迭代到一定程度变成巨石应用时，容易出现修改一分钟，编译半小时”的情况，要是模块隔离不够复杂，代码不够规范，还容易出现模块错综复杂，互相依赖，更改一处地方的代码，往往会影响到应用的其他功能。</p> <p>微前端好处：真正实现各服务解耦，服务间相互独立管理，可以灵活增减服务，例如，一个应用分为 ABCD 四个页面，每个页面单独注册为一个服务，A 服务不可用时，BCD 不受影响，同时可以灵活上线 E 应用或下线 D 应用。</p> <p>微前端难点：难以确定服务边界，当一个应用功能太多时，往往关联较深，难以确定归属。</p> <p>一句话总结：微前端好处多但也有限制，仅适合大型巨石项目，且目前仅有蚂蚁 qiankun 框架开源，其核心原理还是将功能模块单独抽离各自维护，看似也是软件架构万变不离其宗的方法。</p> <h2 id="微服务补充"><a href="#微服务补充" class="header-anchor">#</a> 微服务补充</h2> <blockquote><p>采用新技术，更多不是因为先进，而是因为它能解决痛点。
前端微服务解决的痛点有如下几个：</p></blockquote> <ol><li><p>解决遗留系统问题：
这应该是最主要使用微服务的原因，一些公司历史应用正常运行也没有什么新功能，但随着公司发展或业务增长，不断有新的应用并入进来（使用新的技术），对于这类遗留系统，显然我们花时间精力去重写并没有意义，在即不重写原有系统的基础之下，又可以抽出人力来开发新的业务。其不仅仅对于业务人员来说，是一个相当吸引力的特性；对于技术人员来说，不重写旧的业务，同时还能做一些技术上的挑战，也是一件相当有挑战的事情。</p></li> <li><p>聚合业务
对于有关联的应用来说，用户更希望能直接从一个入口进入，而在前端这边，虽然可以实现链接跳转，但存在用户鉴权、页面跳转体验等问题，聚合业务，用户可以无感的使用几个独立运行部署的应用。</p></li></ol> <h2 id="single-spa"><a href="#single-spa" class="header-anchor">#</a> single-spa</h2> <p>Single-spa 是一个将多个单页面应用聚合为一个整体应用的 JavaScript 微前端框架。 使用 single-spa 进行前端架构设计可以带来很多好处，例如:</p> <blockquote><p>在同一页面上使用多个前端框架 而不用刷新页面 (React, AngularJS, Angular, Ember, 你正在使用的框架)
独立部署每一个单页面应用
新功能使用新框架，旧的单页应用不用重写可以共存
改善初始加载时间，迟加载代码</p></blockquote> <p>Single-spa 不要求具体技术，适用任何可用的构建系统。</p> <p>小试：搭建微前端 demo</p> <h3 id="搭建子服务"><a href="#搭建子服务" class="header-anchor">#</a> 搭建子服务</h3> <h4 id="新建-app-1-服务"><a href="#新建-app-1-服务" class="header-anchor">#</a> 新建 app_1 服务</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>vue create app_1
</code></pre></div><h4 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h4> <p>新建 vue.config.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token keyword">package</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 告诉子应用在这个地址加载静态资源，否则会去基座应用的域名下加载</span>
    publicPath<span class="token operator">:</span> <span class="token string">'//localhost:8081'</span><span class="token punctuation">,</span>
    <span class="token comment">// 开发服务器</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
        port<span class="token operator">:</span> <span class="token number">8081</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    configureWebpack<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 导出umd格式的包，在全局对象上挂载属性package.name，基座应用需要通过这个全局对象获取一些信息，比如子应用导出的生命周期函数</span>
        output<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// library的值在所有子应用中需要唯一</span>
            library<span class="token operator">:</span> <span class="token keyword">package</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="安装-single-spa-vue"><a href="#安装-single-spa-vue" class="header-anchor">#</a> 安装 single-spa-vue</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i single-spa-vue -S
</code></pre></div><h4 id="改造入口文件"><a href="#改造入口文件" class="header-anchor">#</a> 改造入口文件</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /src/main.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> singleSpaVue <span class="token keyword">from</span> <span class="token string">'single-spa-vue'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">const</span> appOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    el<span class="token operator">:</span> <span class="token string">'#microApp'</span><span class="token punctuation">,</span>
    router<span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 支持应用独立运行、部署，不依赖于基座应用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>singleSpaNavigate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> appOptions<span class="token punctuation">.</span>el
    <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span>appOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 基于基座应用，导出生命周期函数</span>
<span class="token keyword">const</span> vueLifecycle <span class="token operator">=</span> <span class="token function">singleSpaVue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Vue<span class="token punctuation">,</span>
    appOptions<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app_1 bootstrap'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vueLifecycle<span class="token punctuation">.</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app_1 mount'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vueLifecycle<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app_1 unmount'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vueLifecycle<span class="token punctuation">.</span><span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="环境配置文件"><a href="#环境配置文件" class="header-anchor">#</a> 环境配置文件</h4> <p>.env 应用独立运行时的开发环境配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">NODE_ENV</span><span class="token operator">=</span>development
<span class="token constant">VUE_APP_BASE_URL</span><span class="token operator">=</span><span class="token operator">/</span>
</code></pre></div><p>.env.micro 作为子应用运行时的开发环境配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">NODE_ENV</span><span class="token operator">=</span>development
<span class="token constant">VUE_APP_BASE_URL</span><span class="token operator">=</span><span class="token operator">/</span>app1
</code></pre></div><p>.env.buildMicro 作为子应用构建生产环境<code>bundle</code>时的环境配置，但这里的<code>NODE_ENV</code>为<code>development</code>，而不是<code>production</code>，是为了方便，这个方便其实<code>single-spa</code>带来的弊端（js entry 的弊端）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">NODE_ENV</span><span class="token operator">=</span>development
<span class="token constant">VUE_APP_BASE_URL</span><span class="token operator">=</span><span class="token operator">/</span>app1
</code></pre></div><h4 id="修改路由文件"><a href="#修改路由文件" class="header-anchor">#</a> 修改路由文件</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// /src/router/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
    <span class="token comment">// 通过环境变量来配置路由的 base url</span>
    base<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_BASE_URL</span><span class="token punctuation">,</span>
    routes<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><h4 id="修改-package-json"><a href="#修改-package-json" class="header-anchor">#</a> 修改 package.json</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app_1&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 独立运行</span>
    <span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service serve&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 作为子应用运行</span>
    <span class="token string">&quot;serve:micro&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service serve --mode micro&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 构建子应用</span>
    <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build --mode buildMicro&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="启动应用"><a href="#启动应用" class="header-anchor">#</a> 启动应用</h4> <div class="language-text extra-class"><pre class="language-text"><code>独立运行  npm run serve
作为子应用运行 npm run serve:micro
</code></pre></div><p>同样的方法创建 demo2，对技术栈无要求，</p> <p>实现效果</p> <p><img src="/assets/imgs/1631152850438.png" alt="1631152850438"></p> <p><strong><img src="/assets/imgs/1631152867139.png" alt="1631152867139"></strong></p> <h3 id="搭建基座应用-可以算是入口应用"><a href="#搭建基座应用-可以算是入口应用" class="header-anchor">#</a> 搭建基座应用，可以算是入口应用</h3> <h4 id="模板创建"><a href="#模板创建" class="header-anchor">#</a> 模板创建</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>vue create layer
</code></pre></div><h4 id="安装-single-spa"><a href="#安装-single-spa" class="header-anchor">#</a> 安装 single-spa</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i single-spa -S
</code></pre></div><h4 id="改造入口文件-2"><a href="#改造入口文件-2" class="header-anchor">#</a> 改造入口文件</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerApplication<span class="token punctuation">,</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'single-spa'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">// 远程加载子应用</span>
<span class="token keyword">function</span> <span class="token function">createScript</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
        script<span class="token punctuation">.</span>src <span class="token operator">=</span> url
        script<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve
        script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject
        <span class="token keyword">const</span> firstScript <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        firstScript<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> firstScript<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 记载函数，返回一个 promise</span>
<span class="token keyword">function</span> <span class="token function">loadApp</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> globalVar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 支持远程加载子应用</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">createScript</span><span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/js/chunk-vendors.js'</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">createScript</span><span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/js/app.js'</span><span class="token punctuation">)</span>
        <span class="token comment">// 这里的return很重要，需要从这个全局对象中拿到子应用暴露出来的生命周期函数</span>
        <span class="token keyword">return</span> window<span class="token punctuation">[</span>globalVar<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子应用列表</span>
<span class="token keyword">const</span> apps <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 子应用名称</span>
        name<span class="token operator">:</span> <span class="token string">'app_1'</span><span class="token punctuation">,</span>
        <span class="token comment">// 子应用加载函数，是一个promise</span>
        app<span class="token operator">:</span> <span class="token function">loadApp</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8081'</span><span class="token punctuation">,</span> <span class="token string">'app_1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 当路由满足条件时（返回true），激活（挂载）子应用</span>
        <span class="token function-variable function">activeWhen</span><span class="token operator">:</span> <span class="token parameter">location</span> <span class="token operator">=&gt;</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/app_1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 传递给子应用的对象</span>
        customProps<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'app_2'</span><span class="token punctuation">,</span>
        app<span class="token operator">:</span> <span class="token function">loadApp</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8082'</span><span class="token punctuation">,</span> <span class="token string">'app_2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">activeWhen</span><span class="token operator">:</span> <span class="token parameter">location</span> <span class="token operator">=&gt;</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/app_2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        customProps<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">// 注册子应用</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> apps<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerApplication</span><span class="token punctuation">(</span>apps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 启动</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="改造-app-vue"><a href="#改造-app-vue" class="header-anchor">#</a> 改造 app.vue</h4> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/app_1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>app1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span> |
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/app_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>app2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 子应用容器 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>microApp<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">#app</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> Avenir<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
    <span class="token property">-webkit-font-smoothing</span><span class="token punctuation">:</span> antialiased<span class="token punctuation">;</span>
    <span class="token property">-moz-osx-font-smoothing</span><span class="token punctuation">:</span> grayscale<span class="token punctuation">;</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #2c3e50<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#nav</span> <span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">#nav a</span> <span class="token punctuation">{</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #2c3e50<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">#nav a.router-link-exact-active</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #42b983<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="改造路由"><a href="#改造路由" class="header-anchor">#</a> 改造路由</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    routes<span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
    base<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BASE_URL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><h4 id="运行"><a href="#运行" class="header-anchor">#</a> 运行</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> run serve
</code></pre></div><h4 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h4> <p><img src="/assets/imgs/1631155940868.png" alt="1631155940868"></p> <p><img src="/assets/imgs/1631156225347.png" alt="1631156225347"></p> <p><img src="/assets/imgs/1631156236899.png" alt="1631156236899"></p> <p>可实现每个服务独立运行，基座应用根据路由加载子服务，</p> <p><img src="/assets/imgs/1631157088701.png" alt="1631157088701"></p> <p>子服务含有各自钩子可按需执行操作。</p> <h4 id="打包部署"><a href="#打包部署" class="header-anchor">#</a> 打包部署</h4> <p>在各个项目的根目录下分别执行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> run build
</code></pre></div><p>上传、配置 nginx 代理</p> <blockquote><ul><li>对于子应用静态资源的加载只需要拦截相应的前缀将请求转发到对应子应用的目录下即可</li> <li>页面刷新只需要拦截到主应用即可，主应用内部自己根据<code>activeWhen</code>去挂载对应的子应用</li></ul></blockquote> <p>至此，简单 single-spa 搭建已完成，深入了解可点击</p> <p><a href="https://juejin.cn/post/6862661545592111111#heading-72" target="_blank" rel="noopener noreferrer">微前端框架 之 single-spa 从入门到精通<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="qiankun"><a href="#qiankun" class="header-anchor">#</a> qiankun</h2> <p>qiankun 是基于 single-spa 做了二次封装的微前端框架，通过解决了 single-spa 的一些弊端和不足，来帮助大家实现更简单、无痛的构建一个生产可用的微前端架构系统。</p> <blockquote><p>single-spa 存在的不足：</p></blockquote> <ul><li><strong>对微应用的侵入性太强</strong></li> <li><strong>样式隔离问题</strong></li> <li><strong>JS 隔离</strong></li> <li><strong>资源预加载</strong></li> <li><strong>应用间通信</strong></li></ul> <p>qiankun 基于 single-spa 做出了改进，此处不深究源码，只探寻如何使用</p> <h3 id="开始搭建-demo"><a href="#开始搭建-demo" class="header-anchor">#</a> 开始搭建 demo</h3> <h4 id="拉取-demo-项目"><a href="#拉取-demo-项目" class="header-anchor">#</a> 拉取 demo 项目</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">git</span> clone https://github.com/umijs/qiankun.git
$ <span class="token builtin class-name">cd</span> qiankun
</code></pre></div><h4 id="安装所需包"><a href="#安装所需包" class="header-anchor">#</a> 安装所需包</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">install</span>
<span class="token function">yarn</span> examples:install
</code></pre></div><h4 id="运行-2"><a href="#运行-2" class="header-anchor">#</a> 运行</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> examples:start
</code></pre></div><h4 id="运行地址"><a href="#运行地址" class="header-anchor">#</a> 运行地址</h4> <p><a href="http://localhost:7099" target="_blank" rel="noopener noreferrer">http://localhost:7099<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="框架目录结构"><a href="#框架目录结构" class="header-anchor">#</a> 框架目录结构</h4> <p><img src="/assets/imgs/206589898f604e858ab810c1004cf7c2_tplv-k3u1fbpfcp-watermark.awebp" alt="img"></p> <p>demo 项目的基座应用准备 react 和 vue 两个版本，微应用也准备了，react、vue、angular 等等，算是比较全面的程序</p> <p><img src="/assets/imgs/1631499010491.png" alt="1631499010491"></p> <p>值得注意的几点</p> <p>在 package.json 中安装了 npm-run-all 包，可并行或顺序执行多个 npm 脚本，这样就能一行代码运行多个应用</p> <p><img src="/assets/imgs/1631499498892.png" alt="1631499498892"></p> <p>father-build，基于 rollup 的库构建工具，father 更加强大</p> <p><img src="/assets/imgs/1631499685326.png" alt="1631499685326"></p> <p>main 和 module 字段，标识组件库的入口，当两者同时存在时，module 字段的优先级高于 main</p> <p><img src="/assets/imgs/1631499722616.png" alt="1631499722616"></p> <h3 id="主应用"><a href="#主应用" class="header-anchor">#</a> 主应用</h3> <h4 id="位置"><a href="#位置" class="header-anchor">#</a> 位置</h4> <p>基座应用（主应用）位于 example 的 main：</p> <p><img src="/assets/imgs/1631499256238.png" alt="1631499256238"></p> <h4 id="webpack-文件"><a href="#webpack-文件" class="header-anchor">#</a> webpack 文件</h4> <p>主应用 webpack，配置了一个开发服务器 devServer、两个 loader (babel-loader、css loader)、一个插件 HtmlWebpackPlugin</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'multiple'</span> <span class="token operator">?</span> <span class="token string">'./multiple.js'</span> <span class="token operator">:</span> <span class="token string">'./index.js'</span><span class="token punctuation">,</span>
    devtool<span class="token operator">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
        open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// port: '7099',</span>
        port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'multiple'</span> <span class="token operator">?</span> <span class="token string">'7099'</span> <span class="token operator">:</span> <span class="token string">'7088'</span><span class="token punctuation">,</span>
        clientLogLevel<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
        disableHostCheck<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        compress<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        historyApiFallback<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        overlay<span class="token operator">:</span> <span class="token punctuation">{</span> warnings<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> errors<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        publicPath<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
        extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.jsx'</span><span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">{</span>
                    loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                    options<span class="token operator">:</span> <span class="token punctuation">{</span>
                        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-react-jsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(le|c)ss$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            filename<span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
            template<span class="token operator">:</span>
                process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'multiple'</span>
                    <span class="token operator">?</span> <span class="token string">'./multiple.html'</span>
                    <span class="token operator">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span>
            minify<span class="token operator">:</span> <span class="token punctuation">{</span>
                removeComments<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>webpack</code> 配置文件的 <code>entry</code> 字段得知入口文件分别为 <code>index.js</code> 和 <code>multiple.js</code></p> <h4 id="主应用路由配置-实现基于路由改变加载对应应用"><a href="#主应用路由配置-实现基于路由改变加载对应应用" class="header-anchor">#</a> 主应用路由配置，实现基于路由改变加载对应应用</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token string">'zone.js'</span> <span class="token comment">// for angular subapp</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
    registerMicroApps<span class="token punctuation">,</span>
    runAfterFirstMounted<span class="token punctuation">,</span>
    setDefaultMountApp<span class="token punctuation">,</span>
    start<span class="token punctuation">,</span>
    initGlobalState<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../es'</span>
<span class="token keyword">import</span> <span class="token string">'./index.less'</span>

<span class="token comment">/**
 * 主应用 **可以使用任意技术栈**
 * 以下分别是 React 和 Vue 的示例，可切换尝试
 */</span>
<span class="token comment">// import render from './render/ReactRender';</span>
<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">'./render/VueRender'</span>

<span class="token comment">/**
 * Step1 初始化应用（可选）
 */</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token parameter">loading</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Step2 注册子应用
 */</span>

<span class="token function">registerMicroApps</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'react16'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7100'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/react16'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'react15'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7102'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/react15'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7101'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/vue'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'angular9'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7103'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/angular9'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'purehtml'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7104'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/purehtml'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'vue3'</span><span class="token punctuation">,</span>
            entry<span class="token operator">:</span> <span class="token string">'//localhost:7105'</span><span class="token punctuation">,</span>
            container<span class="token operator">:</span> <span class="token string">'#subapp-viewport'</span><span class="token punctuation">,</span>
            loader<span class="token punctuation">,</span>
            activeRule<span class="token operator">:</span> <span class="token string">'/vue3'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        beforeLoad<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                    <span class="token string">'[LifeCycle] before load %c%s'</span><span class="token punctuation">,</span>
                    <span class="token string">'color: green;'</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>name
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        beforeMount<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                    <span class="token string">'[LifeCycle] before mount %c%s'</span><span class="token punctuation">,</span>
                    <span class="token string">'color: green;'</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>name
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        afterUnmount<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                    <span class="token string">'[LifeCycle] after unmount %c%s'</span><span class="token punctuation">,</span>
                    <span class="token string">'color: green;'</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>name
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> onGlobalStateChange<span class="token punctuation">,</span> setGlobalState <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">initGlobalState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token string">'qiankun'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[onGlobalStateChange - master]:'</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token function">setGlobalState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    ignore<span class="token operator">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Step3 设置默认进入的子应用
 */</span>
<span class="token function">setDefaultMountApp</span><span class="token punctuation">(</span><span class="token string">'/react16'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Step4 启动应用
 */</span>
<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">runAfterFirstMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[MainApp] first app mounted'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="关于-vuerender-js-与加载中显示有关"><a href="#关于-vuerender-js-与加载中显示有关" class="header-anchor">#</a> 关于 VueRender.js，与加载中显示有关</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue/dist/vue.esm'</span>

<span class="token keyword">function</span> <span class="token function">vueRender</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> loading <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;div id=&quot;subapp-container&quot;&gt;
        &lt;h4 v-if=&quot;loading&quot; class=&quot;subapp-loading&quot;&gt;Loading...&lt;/h4&gt;
        &lt;div id=&quot;subapp-viewport&quot;&gt;&lt;/div&gt;
      &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        el<span class="token operator">:</span> <span class="token string">'#subapp-container'</span><span class="token punctuation">,</span>
        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                loading<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> loading <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app <span class="token operator">=</span> <span class="token function">vueRender</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>loading <span class="token operator">=</span> loading
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="手动加载微应用"><a href="#手动加载微应用" class="header-anchor">#</a> 手动加载微应用</h4> <p>通常这种场景下的微应用是一个不带路由的可独立运行的业务组件，这种使用方式的情况比较少见</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> loadMicroApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../es'</span>
<span class="token keyword">let</span> app
<span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app <span class="token operator">=</span> <span class="token function">loadMicroApp</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'react15'</span><span class="token punctuation">,</span> entry<span class="token operator">:</span> <span class="token string">'//localhost:7102'</span><span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token string">'#react15'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> sandbox<span class="token operator">:</span> <span class="token punctuation">{</span> experimentalStyleIsolation<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#mount'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> mount<span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#unmount'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> unmount<span class="token punctuation">)</span>

<span class="token function">loadMicroApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span> entry<span class="token operator">:</span> <span class="token string">'//localhost:7101'</span><span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token string">'#vue'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="vue-子应用"><a href="#vue-子应用" class="header-anchor">#</a> Vue 子应用</h3> <p>vue 子应用在 <code>examples/vue</code> 目录下，就是一个通过 vue-cli 创建的 vue demo 应用，然后对 <code>vue.config.js</code> 和 <code>main.js</code> 做了一些更改</p> <p><img src="/assets/imgs/1631500568350.png" alt="1631500568350"></p> <h4 id="vue-config-js"><a href="#vue-config-js" class="header-anchor">#</a> vue.config.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">7101</span> <span class="token comment">// dev port</span>
<span class="token comment">// publicPath 没在这里设置，是通过 webpack 提供的全局变量 __webpack_public_path__ 来即时设置的，webpackjs.com/guides/public-path/</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * You will need to set publicPath if you plan to deploy your site under a sub path,
     * for example GitHub Pages. If you plan to deploy your site to https://foo.github.io/bar/,
     * then publicPath should be set to &quot;/bar/&quot;.
     * In most cases please use '/' !!!
     * Detail: https://cli.vuejs.org/config/#publicpath
     */</span>
    outputDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
    assetsDir<span class="token operator">:</span> <span class="token string">'static'</span><span class="token punctuation">,</span>
    filenameHashing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// tweak internal webpack configuration.</span>
    <span class="token comment">// see https://github.com/vuejs/vue-cli/blob/dev/docs/webpack.md</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// host: '0.0.0.0',</span>
        hot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        disableHostCheck<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        port<span class="token punctuation">,</span>
        overlay<span class="token operator">:</span> <span class="token punctuation">{</span>
            warnings<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            errors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置跨域，因为主应用需要通过 fetch 去获取微应用引入的静态资源的，所以必须要求这些静态资源支持跨域</span>
            <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 自定义webpack配置</span>
    configureWebpack<span class="token operator">:</span> <span class="token punctuation">{</span>
        resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
            alias<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'@'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        output<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 把子应用打包成 umd 库格式</span>
            library<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[name]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
            jsonpFunction<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpackJsonp_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="main-js"><a href="#main-js" class="header-anchor">#</a> main.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token string">'./public-path'</span>
<span class="token keyword">import</span> ElementUI <span class="token keyword">from</span> <span class="token string">'element-ui'</span>
<span class="token keyword">import</span> <span class="token string">'element-ui/lib/theme-chalk/index.css'</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ElementUI<span class="token punctuation">)</span>

<span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> container <span class="token punctuation">}</span> <span class="token operator">=</span> props
    <span class="token comment">// 实例化 router，根据应用运行环境设置路由前缀</span>
    router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 作为微应用运行，则设置 /vue 为前缀，否则设置 /</span>
        base<span class="token operator">:</span> window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">?</span> <span class="token string">'/vue'</span> <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
        routes<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        router<span class="token punctuation">,</span>
        store<span class="token punctuation">,</span>
        <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>container <span class="token operator">?</span> container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 从 props 中获取通信方法，监听全局状态的更改和设置全局状态，只能操作一级属性
 * @param {*} props
 */</span>
<span class="token keyword">function</span> <span class="token function">storeTest</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">.</span>onGlobalStateChange <span class="token operator">&amp;&amp;</span>
        props<span class="token punctuation">.</span><span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[onGlobalStateChange - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                    value<span class="token punctuation">,</span>
                    prev
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token boolean">true</span>
        <span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>setGlobalState <span class="token operator">&amp;&amp;</span>
        props<span class="token punctuation">.</span><span class="token function">setGlobalState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            ignore<span class="token operator">:</span> props<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            user<span class="token operator">:</span> <span class="token punctuation">{</span>
                name<span class="token operator">:</span> props<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 导出的三个生命周期函数
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[vue] vue app bootstraped'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[vue] props from main framework'</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span>
    <span class="token function">storeTest</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
    instance <span class="token operator">=</span> <span class="token keyword">null</span>
    router <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="public-path-js"><a href="#public-path-js" class="header-anchor">#</a> public-path.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 在入口文件中使用 ES6 模块导入，则在导入后对 __webpack_public_path__ 进行赋值。
 * 在这种情况下，必须将公共路径(public path)赋值移至专属模块，然后将其在最前面导入
 */</span>
<span class="token comment">// qiankun 设置的全局变量，表示应用作为微应用在运行</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// eslint-disable-next-line no-undef</span>
    __webpack_public_path__ <span class="token operator">=</span> window<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__
<span class="token punctuation">}</span>
</code></pre></div><p>其他 demo 子项目均有实例，具体可自己查看 demo 项目</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>single-spa 提供了微前端的概念，其仍有很多不足和麻烦，后来 qiankun 基于其改进完善，并经过蚂蚁团队上线打磨后开源， 使得我们站在巨人的肩膀上搭建微前端。对于使用我们可能不需要关注底层原理，如果想了解 qiankun 所作的包括 HTML Entry、运行时沙箱、 资源预加载、应用间通信等原理还是需要我们查看源码去理解分析。</p> <p><a href="https://juejin.cn/post/6885211340999229454#heading-44" target="_blank" rel="noopener noreferrer">微前端框架 之 qiankun 从入门到源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://qiankun.umijs.org/zh/guide" target="_blank" rel="noopener noreferrer">qiankun 官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/9/2021, 1:50:13 PM</span></div></footer> <!----> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.053dbcbc.js" defer></script><script src="/assets/js/2.7f8ecedc.js" defer></script><script src="/assets/js/11.aebc598d.js" defer></script>
  </body>
</html>